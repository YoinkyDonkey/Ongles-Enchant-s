<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Admin</title>
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="stylegallery.css">

<style>
  /* MEDIA ADMIN SPECIFIC STYLES */
  #admin-gallery {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    grid-auto-rows: 150px;
    gap: 10px;
  }

  #admin-gallery .mosaic-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--OngleEnchanteSecondColor);
    transition: transform 0.3s, filter 0.3s;
  }

  #admin-gallery .mosaic-item.large {
    grid-row: span 2;
    grid-column: span 2;
  }

  #admin-gallery .mosaic-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #admin-gallery .mosaic-item:hover img {
    transform: scale(1.1);
    filter: brightness(0.8);
  }

  /* Delete button overlay */
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.7);
    border: none;
    color: white;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 8px;
    cursor: pointer;
    z-index: 10;
    transition: background 0.2s;
  }

  .delete-btn:hover {
    background: rgba(255,0,0,0.9);
  }
</style>
</head>
<body>
<header class="site-header">
  <h1>Media Admin</h1>
</header>

<section>
  <h2>Upload Image</h2>
  <form id="upload-form">
    <input type="file" name="images" multiple>
    <button type="submit" class="btn primary">Upload</button>
  </form>
</section>

<section>
  <h2>Gallery</h2>
  <div id="admin-gallery"></div>
</section>

<script>
const adminGallery = document.getElementById("admin-gallery");
const uploadForm = document.getElementById("upload-form");
const API_URL = "http://localhost:3000";
const UPLOADS_URL = API_URL + "/uploads";

let images = [];

// Load images from server
async function loadGallery() {
  try {
    const res = await fetch(`${API_URL}/images`);
    images = await res.json();
    renderGallery();
  } catch(err) {
    console.error("Failed to load gallery:", err);
    adminGallery.innerHTML = "<p>Impossible de charger les images.</p>";
  }
}

// Render gallery with big/small pattern
function renderGallery() {
  adminGallery.innerHTML = "";

  images.forEach((filename, i) => {
    const item = document.createElement("div");
    item.className = "mosaic-item";

    // Big/small pattern: 1,4,7,10,... are big
    if ((i % 3) === 0) item.classList.add("large");

    const img = document.createElement("img");
    img.src = `${UPLOADS_URL}/${filename}`;
    img.alt = "Image Admin";

    // Delete button
    const btn = document.createElement("button");
    btn.className = "delete-btn";
    btn.textContent = "Delete";
    btn.onclick = async (e) => {
      e.stopPropagation();
      if (!confirm("Supprimer cette image?")) return;
      try {
        const res = await fetch(`${API_URL}/delete/${filename}`, { method: "DELETE" });
        const data = await res.json();
        if (data.success) {
          images = images.filter(f => f !== filename);
          renderGallery();
        } else {
          alert("Échec de la suppression");
        }
      } catch(err) {
        alert("Erreur serveur");
        console.error(err);
      }
    };

    item.appendChild(img);
    item.appendChild(btn);
    adminGallery.appendChild(item);
  });
}

// Upload multiple images
uploadForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const files = uploadForm.images.files;
  if (!files.length) return;

  const formData = new FormData();
  for (const file of files) {
    formData.append("image", file);
  }

  try {
    const res = await fetch(`${API_URL}/upload`, {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    if (data.filename) {
      loadGallery();
      uploadForm.reset();
    } else {
      alert("Échec du téléchargement de l’image.");
    }
  } catch(err) {
    alert("Erreur serveur");
    console.error(err);
  }
});

// Initial load
loadGallery();
</script>
</body>
</html>
