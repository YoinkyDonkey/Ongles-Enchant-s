<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Media Admin</title>
<link rel="stylesheet" href="../style.css" />
<link rel="stylesheet" href="stylegallery.css" />
<style>
  /* MEDIA ADMIN SPECIFIC STYLES */
  #admin-gallery {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    grid-auto-rows: 150px;
    gap: 10px;
  }

  #admin-gallery .mosaic-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--OngleEnchanteSecondColor);
    transition: transform 0.3s, filter 0.3s;
  }

  #admin-gallery .mosaic-item.large {
    grid-row: span 2;
    grid-column: span 2;
  }

  #admin-gallery .mosaic-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #admin-gallery .mosaic-item:hover img {
    transform: scale(1.1);
    filter: brightness(0.8);
  }

  /* Delete button overlay */
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.7);
    border: none;
    color: white;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 8px;
    cursor: pointer;
    z-index: 10;
    transition: background 0.2s;
  }

  .delete-btn:hover {
    background: rgba(255, 0, 0, 0.9);
  }

  .btn.danger {
    background: #c0392b;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 15px;
  }

  .btn.danger:hover {
    background: #e74c3c;
  }
</style>
</head>
<body>
<header class="site-header">
  <h1>Media Admin</h1>
</header>

<section>
  <h2>Upload Images</h2>
  <form id="upload-form">
    <input type="file" name="images" multiple />
    <button type="submit" class="btn primary">Upload</button>
  </form>
  <button id="delete-all-btn" class="btn danger">Delete All Images</button>
</section>

<section>
  <h2>Gallery</h2>
  <div id="admin-gallery"></div>
</section>

<script>
  const adminGallery = document.getElementById("admin-gallery");
  const uploadForm = document.getElementById("upload-form");
  const deleteAllBtn = document.getElementById("delete-all-btn");

  // Use LAN-accessible URL based on hostname for other devices on network
  const BASE_URL = `${window.location.protocol}//${window.location.hostname}:3000`;
  const API_URL = `${BASE_URL}/images`;
  const UPLOADS_URL = `${BASE_URL}/uploads`;

  let images = [];

  async function loadGallery() {
    try {
      const res = await fetch(API_URL);
      images = await res.json();
      renderGallery();
    } catch (err) {
      console.error("Failed to load gallery:", err);
      adminGallery.innerHTML = "<p>Impossible de charger les images.</p>";
    }
  }

  function renderGallery() {
    adminGallery.innerHTML = "";

    images.forEach((filename, i) => {
      const item = document.createElement("div");
      item.className = "mosaic-item";

      // Pattern: every 3rd image large
      if (i % 3 === 0) item.classList.add("large");

      const img = document.createElement("img");
      img.src = `${UPLOADS_URL}/${encodeURIComponent(filename)}`;
      img.alt = "Image Admin";

      const btn = document.createElement("button");
      btn.className = "delete-btn";
      btn.textContent = "Delete";
      btn.onclick = async (e) => {
        e.stopPropagation();
        if (!confirm("Supprimer cette image ?")) return;

        try {
          const res = await fetch(`${BASE_URL}/delete/${encodeURIComponent(filename)}`, {
            method: "DELETE",
          });
          const data = await res.json();
          if (data.success) {
            images = images.filter((f) => f !== filename);
            renderGallery();
          } else {
            alert("Échec de la suppression");
          }
        } catch (err) {
          alert("Erreur serveur");
          console.error(err);
        }
      };

      item.appendChild(img);
      item.appendChild(btn);
      adminGallery.appendChild(item);
    });
  }

  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const files = uploadForm.images.files;
    if (!files.length) return alert("Please select files to upload.");

    const formData = new FormData();
    for (const file of files) {
      formData.append("images", file); // plural 'images' to match multer
    }

    try {
      const res = await fetch(`${BASE_URL}/upload`, {
        method: "POST",
        body: formData,
      });
      const data = await res.json();
      if (data.filenames && data.filenames.length > 0) {
        alert(`Uploaded ${data.filenames.length} image(s) successfully!`);
        loadGallery();
        uploadForm.reset();
      } else {
        alert("Échec du téléchargement de l’image.");
      }
    } catch (err) {
      alert("Erreur serveur");
      console.error(err);
    }
  });

  deleteAllBtn.addEventListener("click", async () => {
    if (!confirm("Are you sure you want to delete ALL images?")) return;

    try {
      const res = await fetch(`${BASE_URL}/delete-all`, {
        method: "DELETE",
      });
      const data = await res.json();
      if (data.success) {
        alert(`Deleted ${data.deletedCount} images.`);
        loadGallery();
      } else {
        alert("Échec de la suppression totale.");
      }
    } catch (err) {
      alert("Erreur serveur");
      console.error(err);
    }
  });

  // Initial load
  loadGallery();
</script>
</body>
</html>
